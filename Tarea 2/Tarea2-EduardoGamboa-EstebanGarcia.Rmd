---
title: 'Tarea #2 Metodología CRISP-DM'
author: "Eduardo Gamboa - Esteban García"
date: "5/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("lattice")
library(tidyverse)
library(plyr)
library(ggplot2)
library(knitr)
library(lubridate)
library(comprehenr)
library(dplyr)

library(rpart)
library(rpart.plot)

library(ROCR)
library(pROC)

options(max.print=999999)
```

Nota: Debido a la dificultad de obtener datos de negocios, se procede a realizar un caso ficticio.

# Entendimiento del negocio

## Determinar los objetivos de negocio

Una empresa aseguradora de renombre desea expandirse en un mercado nuevo de seguros, del cual hay evidencia que la competencia está explotando. Dicho mercado es la venta de seguros a casas rodantes, es decir, de vehículos automotores acondicionados para que personas puedan vivir en ellos. A fin de poder entrar en el negocio, es necesario enfocar la oferta del producto a clientes nuevos, y a su vez, encontrar posibles interesados en la cartera de clientes actuales de la empresa.


### Objetivos de negocio

Hay dos objetivos primordiales para el negocio, los cuales se pueden solventar con el diseño descrito en este documento. Estos son: 

1. Poder determinar si dentro de los clientes actuales de la aseguradora hay posibles compradores del nuevo seguro para casa rodantes.

2. Poder determinar si un nuevo cliente, que se acerca a la empresa para contratar otro tipo de servicio, puede estar también interesado en el nuevo seguro de caravanas. 

### Criterios de éxito (en términos de negocio)

Para considerar este proyecto exitoso desde el punto de vista del negocio, se debe de poder obtener una lista de clientes actuales que puedan tener interes en la nueva linea de seguros, y ademas, debe ser posible para los agentes de ventas tener un mecanizmo que les permita determinar si es relevante ofrecer el seguro de caravanas a un nuevo cliente.

## Evaluación de la situación actual

### Inventario de recursos (datos, personal, TI)

Debido a que la compañía aseguradora no posee un seguro de caravanas, no existen datos que puedan usarse como predicción a nivel interno. Sin embargo, como parte del esfuerzo del estudio de mercado, se tienen datos de encuestas y geográficos de clientes actuales de otras aseguradoras, que si ofrecen el producto. Dichos datos son públicos, por lo que es posible utilizarlos dentro de esta compañía.

Se cuenta además con dos personas que trabajan en el análisis de datos y crearán los modelos respectivos basado en los mimos, a nivel de prototipo.

### Requerimientos
Para este proyecto, los requerimientos se expresan de la siguiente manera:

1. Obtener las variables o atributos que son más relevantes para poder predecir si un cliente desea o no adquirir un seguro de caravanas

2. Dadas dichas variables para una persona cualquiera, determinar si la misma podría estar inclinada a comprar el seguro de caravanas. 

Ambos requerimientos cumplen con los objetivos que se plantearon anteriormente, además de ayudar al esfuerzo de estudio de mercado. 

### Supuestos

En este caso en particular, se supone que los datos tomados son estadísticamente variados, dado que los mismos fueron recolectados por una compañía externa, no se tiene control sobre los mismos. Además, se supone que dicha compañía no realizó modificación alguna de los datos fuente, y que los mismos reflejan las intenciones de los clientes y sus localizaciones.  

### Restricciones

Una restricción importante de este proyecto es que los datos y resultados no deben de salir de la compañía. Esto cubre incluso si los resultados no son los deseados, pues se contienen datos geográficos y otros indicadores que pueden considerarse privados por ciertos encuestados, aun cuando ellos aprobaron la utilización de dicha información

### Riesgos y contingencias

Como toda recolección de datos, es posible que los datos estén sucios o mal formateados, debido a errores humanos al realizar la digitalización de estos. Se analizará los datos que se obtuvieron con el fin de poder mitigar este riesgo, y realizar la imputación de los datos en caso de ser necesario. 

Otro riesgo que se puede correr es el hecho de que los clientes mientan en algunas de sus preguntas. Esto es mitigado por el hecho de que es posible que sea un porcentaje pequeño. Al particionar los datos de manera aleatoria, se espera que dichos registros se difuminen y que no afecten de manera negativa el modelo. 

### Beneficios

El beneficio más grande de este proyecto para la compañía es que va a ayudar a analizar un nuevo producto y mercado, del cual aún no se tiene experiencia, y así aumentar la cartera de clientes. Otro beneficio es que da a los ejecutivos de ventas otra herramienta para poder brindar más productos a los clientes actuales.

## Determinar los objetivos de minería de datos

### Objetivos de minería de datos

Desde el punto de vista de la minería de datos, se desea cumplir con un objetivo principal, el cual es realizar una predicción correcta de un cliente, basado en los datos de entrenamiento y de pruebas que fueron otorgados. 

También se espera un análisis de relevancia de las variables que se recolectaron, a fin de poder determinar cuáles son las más relevantes, y cuáles pueden ser eliminadas al ser redundantes.


### Criterios de éxito (desde la perspectiva de minería de datos)

Desde la perspectiva de la minería de datos, se espera poder realizar predicciones con una alta confianza, de al menos un 90%, a fin de poder garantizar que se cumplan los requerimientos de la compañía tanto en el nivel estadístico como en el nivel de exactitud esperado.

## Plan del proyecto

### Evaluación inicial de herramientas y técnicas

Para la realización de este proyecto se utilizarán las siguientes herramientas:

- el lenguaje de programación R, a fin de analizar los datos, y el prototipado de los modelos a utilizar. 
- Se utilizarán dos modelos de clasificación a fin de poder cumplir con los objetivos propuestos. Los mismos son: 
  - Regresión logística: En este modelo se tomarán las diferentes variables del set de datos, y se utilizarán para poder realizar la predicción. Parte de la salida del modelo son las variables con más significancia, por lo que es posible obtenerlas como parte de los entregables
  - Árboles de decisión: Estos modelos buscan generar una especie de "flujo" en el cual se realizan las predicciones respondiendo a preguntas de verdadero/falso. Esto ayudará a obtener las variables significativas, además de los valores que se desea comparar, a fin de poder determinar los objetivos del proyecto.


### Plan del proyecto (incluya para cada fase los recursos necesarios,tiempo estimado, riesgos y contiengencias)

El plan general de este proyecto se especifica a continuación:

Fase                                            | Recursos Necesarios        |Tiempo Estimado | Riesgos y Contingencias
------------------------------------------------| ---------------------------|----------------|---------------------------------------------------------------------------------------
Carga de datos                                  | 2 personas, 2 computadoras | 1 día          | El formato de los datos puede no ser el correcto. Se puede solicitar un reenvío de los mismos con el formato deseado
Análisis de los datos                           | 2 personas, 2 computadoras | 3 días         | El proceso de carga y análisis puede ser extenso basado en las fuentes de datos, es posible realizar esto con más equipo de ser necesario.
Creación y entrenamiento de los modelos de datos| 2 personas, 2 computadoras | 3 días         | Algunos modelos pensados pueden no adaptarse a los datos, lo que puede significar imputación o transformaciones de datos que no son esperados.
		
# Fase de entendimiento de los datos
## Recopilación inicial de datos

Los datos iniciales fueron entregados en formato CSV, e incluyen varias entradas de las personas encuestadas, con datos personales y de contexto geográfico.

### Lista de datasets requeridos
Solamente es requerido un data set, el cual es otorgado por terceros, que incluye las encuestas de las personas que tienen caravanas, y que tienen o no tienen seguros para las mismas. 
### Ubicación de los datasets
El dataset se encuentra en formato CSV el cual está localizado en los servidores de la compañía de seguros. Se tiene acceso para la descarga de ellos hacia las computadoras locales para su procesamiento, siempre que los mismos no salgan de dichos equipos.

### Método de acceso
Se accesan los datos directamente, desde un archivo de texto delimitado por comas, almacenado en los equipos locales de la compañía.

## Descripción de los datos
A continuación un diccionario de datos, los cuales serán los analizados en este trabajo:

1. MOSTYPE Tipo de cliente. Categórica. Los posibles valores son:
    1. Ingreso alto, con niños caros
    2. Provinciano muy importante
    3. Ancianos de alto estado social
    4. Ancianos afluentes con apartamentos
    5. Ancianos mezclados
    6. Cuidadores, ya sea de adultos o de niños
    7. Doble ingreso, sin niños
    8. Familias clase media
    9. Familias modernas completas
    10. Familias estables
    11. Familias iniciando
    12. Familias jóvenes afluentes
    13. Familia joven, todos estadounidenses
    14. Cosmopolita joven
    15. Cosmopolita anciano
    16. Estudiantes en apartamentos
    17. Recién graduados en la ciudad
    18. Joven soltero
    19. Joven suburbano
    20. Étnicamente diverso
    21. Joven urbano sin beneficios materiales
    22. Varias personas que viven en apartamentos
    23. Jóvenes y creciendo
    24. Jóvenes, baja educación
    25. Ancianos jóvenes en la ciudad
    26. Ancianos dueños de casa
    27. Ancianos en apartamentos
    28. Ancianos residenciales
    29. Ancianos sin patio delantero
    30. Ancianos solteros religiosos
    31. Católicos con bajo ingreso
    32. Ancianos mezclados
    33. Familias largas de baja clase
    34. Familias largas, con hijos empleados
    35. Familias de villas
    36. Familia con adolescentes
    37. Habitantes mezclados de pueblos pequeños
    38. Familia tradicional
    39. Familias religiosas largas
    40  Largas Familia de granjas
    41. Rurales mezcladas

2. MAANTHUI Número de casas, de 1 a 10
3. MGEMOMV Tamaño promedio de casa, de 1 a 6
4. MGEMLEEF Edad promedio.
    1. 20-30 años
    2. 30-40 años
    3. 40-50 años
    4. 50-60 años
    5. 60-70 años
    6. 70-80 años
5. MOSHOOFD Categórica. Tipo de cliente principal.
    1. Hedonista exitoso
    2. Granjero conducido
    3. Familia Promedio
    4. Deudor de préstamos para carreras
    5. Viviendo bien
    6. Ancianos viajeros
    7. Retirados y religiosos
    8. Familia con personas adultas
    9. Familias conservativas
    10. Granjeros
6. MGODRK Católicos romanos
7. MGODPR Protestantes
8. MGODOV Otra religión
9. MGODGE Sin religión
10. MRELGE Casado
11. MRELSA Viviendo Juntos
12. MRELOV Otra relación
13. MFALLEEN Solteros
14. MFGEKIND Ocupantes de casa sin niños
15. MFWEKIND Ocupantes de casa sin niños
16. MOPLHOOG Educación de alto nivel
17. MOPLMIDD Educación media
18. MOPLLAAG Educación baja
19. MBERHOOG Alto estatus
20. MBERZELF Emprendedor
21. MBERBOER Granjero
22. MBERMIDD Administrador medio
23. MBERARBG Trabajador con habilidades
24. MBERARBO Trabajador sin habilidades
25. MSKA Clase social A
26. MSKB1 Clase social B1
27. MSKB2 Clase social B2
28. MSKC Clase social C
29. MSKD Clase social D
30. MHHUUR Casa rentada
31. MHKOOP Dueños de casa
32. MAUT1 1 auto
33. MAUT2 2 autos
34. MAUT0 Sin autos
35. MZFONDS Servicio nacional de salud
36. MZPART Seguro de salud privado
37. MINKM30 Ingreso menor de  30.000
38. MINK3045 Ingreso entre 30-45.000
39. MINK4575 Ingreso entre 45-75.000
40. MINK7512 Ingreso entre 75-122.000
41. MINK123M Ingreso mayor que 123.000
42. MINKGEM Ingreso promedio
43. MKOOPKLA Clase de poder de compra
44. PWAPART Contribución de seguros de terceros
45. PWABEDR Contribución de seguros de terceros
46. PWALAND Contribución de seguros de terceros en agricultura
47. PPERSAUT Contribución en contratos de seguros de automóviles
48. PBESAUT Contribución en contratos de seguros en camionetas de entrega
49. PMOTSCO Contribución en contratos de seguros motocicletas
50. PVRAAUT Contribución en contratos de seguros de camiones
51. PAANHANG Contribución en contratos de seguros de trailers
52. PTRACTOR Contribución en contratos de seguros de tractores
53. PWERKT Contribución en contratos de seguros de maquinas de agrcultura
54. PBROM Contribución en contratos de seguros motocicletas pequeñas
55. PLEVEN Contribución de seguros de vida
56. PPERSONG Contribución en contratos de seguros de accidentes privados
57. PGEZONG Contribución en contratos de seguros de accidentes de familia
58. PWAOREG Contrato de seguros de contribución de invalidez
59. PBRAND Contrato de seguros de contribución de seguros contra incendios
60. PZEILPL Contrato de seguros de contribución en seguros de tablas de surf
61. PPLEZIER Contrato de seguros de contribución en seguros de botes
62. PFIETS Contrato de seguros de contribución en seguros de bicicletas
63. PINBOED Contrato de seguros de contribución de seguros de propiedades
64. PBYSTAND Contrato de seguros de contribución de seguro social
65. AWAPART Número de seguros de terceros 
66. AWABEDR Número de firmas de seguros de terceras personas
67. AWALAND Número de seguros de terceras personas
68. APERSAUT Número de contratos de seguros de automóviles
69. ABESAUT Número de contratos de seguros de camionetas de entrega
70. AMOTSCO Número de contratos de seguros de motocicletas o scooter
71. AVRAAUT Número de contratos de seguros de camiones
72. AAANHANG Número de contratos de seguros de trailer
73. ATRACTOR Número de contratos de seguros tractor
74. AWERKT Número de contratos de seguros de maquinaria de agricultura
75. ABROM Número de contratos de seguros en motocicletas pequeñas
76. ALEVEN Número de seguros de vida
77. APERSONG Número de contratos de seguros de accidente privado
78. AGEZONG Número de contratos de seguros de accidentes familiares
79. AWAOREG Número de contratos de seguros de invalidez familiares
80. ABRAND Número de contratos de seguros de incendios
81. AZEILPL Número de contratos de seguros de tablas de surf
82. APLEZIER Número de contratos de seguros de botes
83. AFIETS Número de contratos de seguros de bicicletas
84. AINBOED Número de contratos de seguros de propiedades
85. ABYSTAND Número de contratos de seguros de seguro social
86. CARAVAN Número de contratos de casas móviles. 0 o 1.

Además, como notas aclaratorias:

1. Las variables que inician con M son variables de área, no específicas del cliente. Se basan en el código ZIP donde el cliente está ubicado, y reflejan la distribución de la variable en cuestión
1. Las siguientes columnas comparten su dominio, los valores que solo pertenecen a una sola columna están especificados en la lista anterior:
    1. Columnas de la 6 a la 42, todas estas se comportan como porcentajes. Los valores se especifican a continuación:
        0. 0%
        1. 1 - 10%
        2. 11 - 23%
        3. 24 - 36%
        4. 37 - 49%
        5. 50 - 62%
        6. 63 - 75%
        7. 76 - 88%
        8. 89 - 99%
        9. 100%
    1. Las columnas de la 43 a la 64, todas son valores monetarios. Sus posibles valores son:
        0. 0
        1. 1 a 49
        2. 50 a 99
        3. 100 a 199
        4. 200 a 499
        5. 500 a 999
        6. 1000 a 4999
        7. 5000 a 9999
        8. 10.000 a 19.999
        9. 20.000 o mayor
    1. Las columnas de la 65  a la 85, son numéricas, con rango de 0 a 12

## Exploración de los datos

Se procede a la carga de los datos
```{r carga_datos}
columnas = c('MOSTYPE', 'MAANTHUI', 'MGEMOMV', 'MGEMLEEF', 'MOSHOOFD', 'MGODRK', 'MGODPR', 'MGODOV', 'MGODGE', 'MRELGE', 'MRELSA', 'MRELOV', 'MFALLEEN', 'MFGEKIND', 'MFWEKIND', 'MOPLHOOG', 'MOPLMIDD', 'MOPLLAAG', 'MBERHOOG', 'MBERZELF', 'MBERBOER', 'MBERMIDD', 'MBERARBG', 'MBERARBO', 'MSKA', 'MSKB1', 'MSKB2', 'MSKC', 'MSKD', 'MHHUUR', 'MHKOOP', 'MAUT1', 'MAUT2', 'MAUT0', 'MZFONDS', 'MZPART', 'MINKM30', 'MINK3045', 'MINK4575', 'MINK7512', 'MINK123M', 'MINKGEM', 'MKOOPKLA', 'PWAPART', 'PWABEDR', 'PWALAND', 'PPERSAUT', 'PBESAUT', 'PMOTSCO', 'PVRAAUT', 'PAANHANG', 'PTRACTOR', 'PWERKT', 'PBROM', 'PLEVEN', 'PPERSONG', 'PGEZONG', 'PWAOREG', 'PBRAND', 'PZEILPL', 'PPLEZIER', 'PFIETS', 'PINBOED', 'PBYSTAND', 'AWAPART', 'AWABEDR', 'AWALAND', 'APERSAUT', 'ABESAUT', 'AMOTSCO', 'AVRAAUT', 'AAANHANG', 'ATRACTOR', 'AWERKT', 'ABROM', 'ALEVEN', 'APERSONG', 'AGEZONG', 'AWAOREG', 'ABRAND', 'AZEILPL', 'APLEZIER', 'AFIETS', 'AINBOED', 'ABYSTAND', 'CARAVAN')
datos = read.table('ticdata2000.txt', header = F, col.names = columnas)
datos$MOSTYPE <- factor(datos$MOSTYPE, levels = 1:41)
datos$MGEMLEEF <- factor(datos$MGEMLEEF, levels = 1:6)
datos$MOSHOOFD <- factor(datos$MOSHOOFD, levels = 1:10)
datos$MGODRK <- factor(datos$MGODRK, levels = 0:9)
datos$MGODPR <- factor(datos$MGODPR, levels = 0:9)
datos$MGODOV <- factor(datos$MGODOV, levels = 0:9)
datos$MGODGE <- factor(datos$MGODGE, levels = 0:9)
datos$MRELGE <- factor(datos$MRELGE, levels = 0:9)
datos$MRELSA <- factor(datos$MRELSA, levels = 0:9)
datos$MRELOV <- factor(datos$MRELOV, levels = 0:9)
datos$MFALLEEN <- factor(datos$MFALLEEN, levels = 0:9)
datos$MFGEKIND <- factor(datos$MFGEKIND, levels = 0:9)
datos$MFWEKIND <- factor(datos$MFWEKIND, levels = 0:9)
datos$MOPLHOOG <- factor(datos$MOPLHOOG, levels = 0:9)
datos$MOPLMIDD <- factor(datos$MOPLMIDD, levels = 0:9)
datos$MOPLLAAG <- factor(datos$MOPLLAAG, levels = 0:9)
datos$MBERHOOG <- factor(datos$MBERHOOG, levels = 0:9)
datos$MBERZELF <- factor(datos$MBERZELF, levels = 0:9)
datos$MBERBOER <- factor(datos$MBERBOER, levels = 0:9)
datos$MBERMIDD <- factor(datos$MBERMIDD, levels = 0:9)
datos$MBERARBG <- factor(datos$MBERARBG, levels = 0:9)
datos$MBERARBO <- factor(datos$MBERARBO, levels = 0:9)
datos$MSKA <- factor(datos$MSKA, levels = 0:9)
datos$MSKB1 <- factor(datos$MSKB1, levels = 0:9)
datos$MSKB2 <- factor(datos$MSKB2, levels = 0:9)
datos$MSKC <- factor(datos$MSKC, levels = 0:9)
datos$MSKD <- factor(datos$MSKD, levels = 0:9)
datos$MHHUUR <- factor(datos$MHHUUR, levels = 0:9)
datos$MHKOOP <- factor(datos$MHKOOP, levels = 0:9)
datos$MAUT1 <- factor(datos$MAUT1, levels = 0:9)
datos$MAUT2 <- factor(datos$MAUT2, levels = 0:9)
datos$MAUT0 <- factor(datos$MAUT0, levels = 0:9)
datos$MZFONDS <- factor(datos$MZFONDS, levels = 0:9)
datos$MZPART <- factor(datos$MZPART, levels = 0:9)
datos$MINKM30 <- factor(datos$MINKM30, levels = 0:9)
datos$MINK3045 <- factor(datos$MINK3045, levels = 0:9)
datos$MINK4575 <- factor(datos$MINK4575, levels = 0:9)
datos$MINK7512 <- factor(datos$MINK7512, levels = 0:9)
datos$MINK123M <- factor(datos$MINK123M, levels = 0:9)
datos$MINKGEM <- factor(datos$MINKGEM, levels = 0:9)
datos$MKOOPKLA <- factor(datos$MKOOPKLA, levels = 0:9)
datos$PWAPART <- factor(datos$PWAPART, levels = 0:9)
datos$PWABEDR <- factor(datos$PWABEDR, levels = 0:9)
datos$PWALAND <- factor(datos$PWALAND, levels = 0:9)
datos$PPERSAUT <- factor(datos$PPERSAUT, levels = 0:9)
datos$PBESAUT <- factor(datos$PBESAUT, levels = 0:9)
datos$PMOTSCO <- factor(datos$PMOTSCO, levels = 0:9)
datos$PVRAAUT <- factor(datos$PVRAAUT, levels = 0:9)
datos$PAANHANG <- factor(datos$PAANHANG, levels = 0:9)
datos$PTRACTOR <- factor(datos$PTRACTOR, levels = 0:9)
datos$PWERKT <- factor(datos$PWERKT, levels = 0:9)
datos$PBROM <- factor(datos$PBROM, levels = 0:9)
datos$PLEVEN <- factor(datos$PLEVEN, levels = 0:9)
datos$PPERSONG <- factor(datos$PPERSONG, levels = 0:9)
datos$PGEZONG <- factor(datos$PGEZONG, levels = 0:9)
datos$PWAOREG <- factor(datos$PWAOREG, levels = 0:9)
datos$PBRAND <- factor(datos$PBRAND, levels = 0:9)
datos$PZEILPL <- factor(datos$PZEILPL, levels = 0:9)
datos$PPLEZIER <- factor(datos$PPLEZIER, levels = 0:9)
datos$PFIETS <- factor(datos$PFIETS, levels = 0:9)
datos$PINBOED <- factor(datos$PINBOED, levels = 0:9)
datos$PBYSTAND <- factor(datos$PBYSTAND, levels = 0:9)
datos$CARAVAN <- factor(datos$CARAVAN)
```

Se revisa la distribución de los datos a predecir
```{r distribucion-variable-predecir}
barplot(table(datos$CARAVAN), 
        main="Distribución de compra de seguros",
        xlab = "Compró un seguro", 
        ylab="Cantidad")
```

Es claro ver que la gran mayoría de los encuestados no compro un seguro de caravanas. Esto podría generar un modelo que identifique un posible nuevo comprador utilizando las diferencias en las variables en cuestión, sin embargo, con una posibilidad más alta de que retorne falsos positivos. 

Seguidamente, entre los que compraron un seguro de caravanas, se procede a realizar un análisis de los tipos de clientes.

```{r grafico seguros y clientes que adquirieron seguro}
compraronSeguros = datos[datos$CARAVAN == 1,]
barplot(table(compraronSeguros$MOSTYPE),
        main = "Distribución de tipos de clientes que \ncompraron seguro",
        xlab = "Tipo de cliente",
        ylab = "cantidad de clientes")
```

En este caso, los clientes que más compraron caravanas son del tipo 33, y del tipo 8. Dichos tipos corresponden al tipo de clase baja con grandes familias, y a las familias de clase media. Es posible observar la misma relación, respecto a los que no adquirieron un seguro: 
```{r distribucion_clientes_sin_seguro}
noCompraronSeguros = datos[datos$CARAVAN == 0,]
barplot(table(noCompraronSeguros$MOSTYPE),
        main = "Distribución de tipos de clientes que \nno compraron seguro",
        xlab = "Tipo de cliente",
        ylab = "cantidad de clientes")
```
Para este caso, se observa que la gran mayoría de los que no compraron seguros, son también del tipo 33, familias de clase baja con grandes familias. Es de notar que este tipo de clientes también compraron un seguro según la distribución. Sin embargo, la diferencia en la proporción de los datos indica que el tipo de cliente 33 no es un buen indicador 

Otra variable importante que se puede definir es el ingreso de los clientes, pues el ingreso neto de los encuestados puede ser una razón para no comprar un seguro. Es de notar que dicho promedio de ingresos es en la zona donde los encuestados viven

```{r distribucion-ingresos}
barplot(table(datos$MINKGEM),
        main = "Distribución de tipos de ingreso promedio por clientes",
        xlab = "Tipo de ingreso promedio",
        ylab = "cantidad de clientes")
```

Los dos tipos de ingreso más comunes son el 3 y el 4, que reflejan ingresos en la zona donde se vive con valores entre 24% y 36% (para el caso del valor 3) y un 37% - 49% para el valor 4. 


Otro de los valores a considerar es la existencia de seguros contratados por el cliente que tengan similitud con el seguro nuevo, como lo puede ser, seguros para automóviles.
```{r seguros de automoviles}

noCompraronSeguros = datos[datos$CARAVAN == 1,]

barplot(table(noCompraronSeguros$APERSAUT),
        main = "Seguros de automóviles para compradores de seguro de caravana",
        xlab = "Tipo de cliente",
        ylab = "cantidad de clientes")

```

```{r}

noCompraronSeguros = datos[datos$CARAVAN == 0,]

barplot(table(noCompraronSeguros$APERSAUT),
        main = "Seguros de automóviles para no compradores de seguro de caravana",
        xlab = "Tipo de cliente",
        ylab = "cantidad de clientes")

```

De los dos gráficos anteriores podemos ver que en el grupo de los compradores de seguros de caravana es más frecuente la existencia de seguros para automóviles.

Otra forma de poder analizar una posible relación entre las familias y los que compran caravanas es, principalmente, el ingreso de las mismas.

```{r}
histogram(~MINKGEM|CARAVAN,data=datos,xlab="Ingreso promedio", main="Ingreso promedio por Seguro Caravana")
```

En las distribuciones obtenidas, es posible ver que los ingresos de los que compraron caravanas, es mayor, sin embargo, la diferencia no es tan significativa respecto a los que no adquirieron el producto. Incluso personas con menor ingreso en promedio compraron seguros. Es de notar que dichos ingresos son por zona, no personales, de donde vive las personas.

Finalmente, se puede analizar los demás seguros adquiridos en relación de si compraron o no una caravana. Esto, para poder determinar si hay una relación entre los demás productos y el producto de interés


```{r}
#Terceros
boxplot(as.integer(datos$AWAPART) ~ datos$CARAVAN, main = "Distribución Seguros de terceros", ylab = "Cantidad", xlab = "¿Seguro Caravana?")
#Automóviles
boxplot(as.integer(datos$APERSAUT) ~ datos$CARAVAN, main = "Distribución Seguros de auto", ylab = "Cantidad", xlab = "¿Seguro Caravana?")
#Camionetas de reparto
boxplot(as.integer(datos$ABESAUT) ~ datos$CARAVAN, main = "Distribución Seguros de camionetas", ylab = "Cantidad", xlab = "¿Seguro Caravana?")
#Motocicletas
boxplot(as.integer(datos$AMOTSCO) ~ datos$CARAVAN, main = "Distribución Seguros de motocicletas", ylab = "Cantidad", xlab = "¿Seguro Caravana?")
#Camiones
boxplot(as.integer(datos$AVRAAUT) ~ datos$CARAVAN, main = "Distribución Seguros de camiones", ylab = "Cantidad", xlab = "¿Seguro Caravana?")
#Seguros de vida
boxplot(as.integer(datos$ALEVEN) ~ datos$CARAVAN, main = "Distribución Seguros de vida", ylab = "Cantidad", xlab = "¿Seguro Caravana?")
#Accidentes
boxplot(as.integer(datos$AGEZONG) ~ datos$CARAVAN, main = "Distribución Seguros de accidentes familiares", ylab = "Cantidad", xlab = "¿Seguro Caravana?")
#Propiedades
boxplot(as.integer(datos$AINBOED) ~ datos$CARAVAN, main = "Distribución Seguros de propiedades", ylab = "Cantidad", xlab = "¿Seguro Caravana?")
#Seguro social
#summary(datos$ABYSTAND)
boxplot(as.integer(datos$ABYSTAND) ~ datos$CARAVAN, main = "Distribución Seguros de seguro social", ylab = "Cantidad", xlab = "¿Seguro Caravana?")
```

En los gráficos anteriores, no se aprecia alguna diferencia que permita discernir si el hecho de comprar un seguro determinado, o varios de ellos, implique la compra de un seguro de caravanas particular. 


## Calidad de los datos
Se procede a la búsqueda de datos nulos dentro del conjunto de datos
```{r} 
sum(is.na(datos))
```

Es claro ver que no se encuentran datos nulos. 

Se procede a analizar que las variables tengan el rango correcto a nivel de los factores. En primer lugar, la variable del tipo de cliente: 

```{r}
sapply(select(datos,c("MOSTYPE")), levels)
```
En este caso, los niveles son correctos, se cuentan con los 41 casos deseados. 

En el caso de la variable del número de casas, se verifica que está en el dominio correcto

```{r}
summary(datos$MAANTHUI)
```

```{r}
summary(datos$MGEMOMV)
```

Esta variable se encuentra también dentro del rango aceptado. El diccionario de datos original indica que debe de estar de 0 a 6, es claro que en este caso dichas variables no está incluido el último valor

Para la variable de Edad Promedio:

```{r}
table(datos$MGEMLEEF)
```

Se observa que los niveles del factor son correctos, se tienen 6 para distintos tipos de rangos de edad

Para el tipo de cliente principal: 
```{r}
table(datos$MOSHOOFD)
```

Es observable según el resultado anterior que los niveles incluidos son los correctos, sin omitir o agregar alguno. 

Las siguientes variables comparten su domino, así que se analizan con una sola llamada
```{r}
cols = c("MGODRK", "MGODPR", "MGODOV", "MGODGE", "MRELGE", "MRELSA", "MRELOV", "MFALLEEN", "MFGEKIND", "MFWEKIND", "MOPLHOOG", "MOPLMIDD", "MOPLLAAG", "MBERHOOG", "MBERZELF", "MBERBOER", "MBERMIDD", "MBERARBG", "MBERARBO", "MSKA", "MSKB1", "MSKB2", "MSKC", "MSKD", "MHHUUR", "MHKOOP", "MAUT1", "MAUT2", "MAUT0", "MZFONDS", "MZPART", "MINKM30", "MINK3045", "MINK4575", "MINK7512", "MINK123M", "MINKGEM")

for (col in cols) {
  cat(col)
  print(table(datos[col]))
  cat("\n")
}

```

Todas estas variables comparten el dominio de 0 a 9 según su rango porcentual. Es claro que esto se cumple según la tabla anterior
```{r}

cols = c("MKOOPKLA", "PWAPART", "PWABEDR", "PWALAND", "PPERSAUT", "PBESAUT", "PMOTSCO", "PVRAAUT", "PAANHANG", "PTRACTOR", "PWERKT", "PBROM", "PLEVEN", "PPERSONG", "PGEZONG", "PWAOREG", "PBRAND", "PZEILPL", "PPLEZIER", "PFIETS", "PINBOED", "PBYSTAND")

for (col in cols) {
  cat(col)
  print(table(datos[col]))
  cat("\n")
}

```

Todos los datos están dentro del dominio en cuestión. 

Finalmente, para las variables numéricas:

```{r}

summary(datos[c("AWAPART", "AWABEDR", "AWALAND", "APERSAUT", "ABESAUT", "AMOTSCO", "AVRAAUT", "AAANHANG", "ATRACTOR", "AWERKT", "ABROM", "ALEVEN", "APERSONG", "AGEZONG", "AWAOREG", "ABRAND", "AZEILPL", "APLEZIER", "AFIETS", "AINBOED", "ABYSTAND")])

```

Todas las variables se ajustan a los rangos determinados. 

# Fase de Preparación de los datos

Para este set de datos, no es necesario realizar limpiezas de los mismos, ni es necesaria la creación de nuevos atributos, pues los modelos se encargan de realizar operaciones sobre las variables categóricas. 

#Modelado
Tal y como se menciona en la sección de tecnicas a aplciar, se procede a aplicar dos modelos de clasificación a los datos.

##Regresión Logística
Se procede a crear un modelo de regresión con todas las variables, a fin de indentificar cuales pueden ser mas signigicativas en esta primera iteración. Notese que se utiliza una regresión binomial pues la variable a predecir tiene dos valores posibles únicamente:
```{r}
modelo.logistica <- glm(CARAVAN ~ ., data = datos, family = binomial)
summary(modelo.logistica)
```

En la tabla anterior se aprecia que no todas las vaaibles son significantes al producir una predicción. Debido a que las mismas no son útillies, podemos elimnarlas del modelo. Para estto, se toman las variables con una significancia menor a 0.01:
```{r}
modelo.logistica <- glm(CARAVAN ~ ALEVEN + APERSAUT + MAUT0 + MBERARBG + MBERARBO + MBERBOER + MBERHOOG + MBERMIDD + MHHUUR + MINK7512 + MOPLHOOG + MOPLLAAG + MOSTYPE + MSKB2 + PLEVEN + PPERSAUT + PPLEZIER , data = datos, family = binomial)
summary(modelo.logistica)
```
En esta segunda iteración del modelo, el AIC bajo, lo que implica que este segundo modelo se ajusta un poco mejor a los datos. Sin embargo, otras variables han perdido significancia ahora. Se procede a realizar una nueva limpieza del modelo
```{r}
modelo.logistica <- glm(CARAVAN ~ ALEVEN + APERSAUT + MAUT0 + MBERARBG  + MHHUUR + MINK7512  + MOPLLAAG  + PLEVEN + PPERSAUT + PPLEZIER , data = datos, family = binomial)
summary(modelo.logistica)
```

En esta iteración final, todas las variables aportan algún nivel de significancia, lo que hace que este modelo sea el elegido. Es de notar que el AIC es algo alto, pero ha bajado durante las iteraciones del mismo. Este análisis tambien nos hace ver que variables son ms significativas, y debido a que son categóricas, es posible saber que valores influyen mas en el mismo.

## Árbol de decision
Un caso útil para este modelo, tal y como se desribió anteriormente, es el árbol de decisión. Este permitirá que se siga un flujo para determinar quien comprará un seguro o no. Se implementa uno a continuación: 
```{r}
modelo.arbol = rpart(CARAVAN ~ ., data= datos)
prp(modelo.arbol)
```

En este caso, el modelo dice que nadie compra un seguro. Sin embargo, podemos eliminar las variables que no fueron signigicantes basadas en el modelo anterior, pues las demás pueden simplemente meter ruido o ser contradictorias: 
```{r}
modelo.arbol = rpart(CARAVAN ~ MGODRK + MGODOV + MGODGE + MOPLHOOG + MBERMIDD + MBERARBG + MBERARBO + MAUT0 + PPERSAUT, data = datos)
prp(modelo.arbol)
```

De nuevo, no es posible predecir con un árbol de decisión y las variables dadas. 

## Evaluación de los modelos

Priemro, se cargan y transforman los datos de prueba suministrados: 
```{r}
columnas = c('MOSTYPE', 'MAANTHUI', 'MGEMOMV', 'MGEMLEEF', 'MOSHOOFD', 'MGODRK', 'MGODPR', 'MGODOV', 'MGODGE', 'MRELGE', 'MRELSA', 'MRELOV', 'MFALLEEN', 'MFGEKIND', 'MFWEKIND', 'MOPLHOOG', 'MOPLMIDD', 'MOPLLAAG', 'MBERHOOG', 'MBERZELF', 'MBERBOER', 'MBERMIDD', 'MBERARBG', 'MBERARBO', 'MSKA', 'MSKB1', 'MSKB2', 'MSKC', 'MSKD', 'MHHUUR', 'MHKOOP', 'MAUT1', 'MAUT2', 'MAUT0', 'MZFONDS', 'MZPART', 'MINKM30', 'MINK3045', 'MINK4575', 'MINK7512', 'MINK123M', 'MINKGEM', 'MKOOPKLA', 'PWAPART', 'PWABEDR', 'PWALAND', 'PPERSAUT', 'PBESAUT', 'PMOTSCO', 'PVRAAUT', 'PAANHANG', 'PTRACTOR', 'PWERKT', 'PBROM', 'PLEVEN', 'PPERSONG', 'PGEZONG', 'PWAOREG', 'PBRAND', 'PZEILPL', 'PPLEZIER', 'PFIETS', 'PINBOED', 'PBYSTAND', 'AWAPART', 'AWABEDR', 'AWALAND', 'APERSAUT', 'ABESAUT', 'AMOTSCO', 'AVRAAUT', 'AAANHANG', 'ATRACTOR', 'AWERKT', 'ABROM', 'ALEVEN', 'APERSONG', 'AGEZONG', 'AWAOREG', 'ABRAND', 'AZEILPL', 'APLEZIER', 'AFIETS', 'AINBOED', 'ABYSTAND')
datos.prueba <- read.table('ticeval2000.txt', header = F, col.names = columnas)

datos.prueba$MOSTYPE <- factor(datos.prueba$MOSTYPE, levels = 1:41)
datos.prueba$MGEMLEEF <- factor(datos.prueba$MGEMLEEF, levels = 1:6)
datos.prueba$MOSHOOFD <- factor(datos.prueba$MOSHOOFD, levels = 1:10)
datos.prueba$MGODRK <- factor(datos.prueba$MGODRK, levels = 0:9)
datos.prueba$MGODPR <- factor(datos.prueba$MGODPR, levels = 0:9)
datos.prueba$MGODOV <- factor(datos.prueba$MGODOV, levels = 0:9)
datos.prueba$MGODGE <- factor(datos.prueba$MGODGE, levels = 0:9)
datos.prueba$MRELGE <- factor(datos.prueba$MRELGE, levels = 0:9)
datos.prueba$MRELSA <- factor(datos.prueba$MRELSA, levels = 0:9)
datos.prueba$MRELOV <- factor(datos.prueba$MRELOV, levels = 0:9)
datos.prueba$MFALLEEN <- factor(datos.prueba$MFALLEEN, levels = 0:9)
datos.prueba$MFGEKIND <- factor(datos.prueba$MFGEKIND, levels = 0:9)
datos.prueba$MFWEKIND <- factor(datos.prueba$MFWEKIND, levels = 0:9)
datos.prueba$MOPLHOOG <- factor(datos.prueba$MOPLHOOG, levels = 0:9)
datos.prueba$MOPLMIDD <- factor(datos.prueba$MOPLMIDD, levels = 0:9)
datos.prueba$MOPLLAAG <- factor(datos.prueba$MOPLLAAG, levels = 0:9)
datos.prueba$MBERHOOG <- factor(datos.prueba$MBERHOOG, levels = 0:9)
datos.prueba$MBERZELF <- factor(datos.prueba$MBERZELF, levels = 0:9)
datos.prueba$MBERBOER <- factor(datos.prueba$MBERBOER, levels = 0:9)
datos.prueba$MBERMIDD <- factor(datos.prueba$MBERMIDD, levels = 0:9)
datos.prueba$MBERARBG <- factor(datos.prueba$MBERARBG, levels = 0:9)
datos.prueba$MBERARBO <- factor(datos.prueba$MBERARBO, levels = 0:9)
datos.prueba$MSKA <- factor(datos.prueba$MSKA, levels = 0:9)
datos.prueba$MSKB1 <- factor(datos.prueba$MSKB1, levels = 0:9)
datos.prueba$MSKB2 <- factor(datos.prueba$MSKB2, levels = 0:9)
datos.prueba$MSKC <- factor(datos.prueba$MSKC, levels = 0:9)
datos.prueba$MSKD <- factor(datos.prueba$MSKD, levels = 0:9)
datos.prueba$MHHUUR <- factor(datos.prueba$MHHUUR, levels = 0:9)
datos.prueba$MHKOOP <- factor(datos.prueba$MHKOOP, levels = 0:9)
datos.prueba$MAUT1 <- factor(datos.prueba$MAUT1, levels = 0:9)
datos.prueba$MAUT2 <- factor(datos.prueba$MAUT2, levels = 0:9)
datos.prueba$MAUT0 <- factor(datos.prueba$MAUT0, levels = 0:9)
datos.prueba$MZFONDS <- factor(datos.prueba$MZFONDS, levels = 0:9)
datos.prueba$MZPART <- factor(datos.prueba$MZPART, levels = 0:9)
datos.prueba$MINKM30 <- factor(datos.prueba$MINKM30, levels = 0:9)
datos.prueba$MINK3045 <- factor(datos.prueba$MINK3045, levels = 0:9)
datos.prueba$MINK4575 <- factor(datos.prueba$MINK4575, levels = 0:9)
datos.prueba$MINK7512 <- factor(datos.prueba$MINK7512, levels = 0:9)
datos.prueba$MINK123M <- factor(datos.prueba$MINK123M, levels = 0:9)
datos.prueba$MINKGEM <- factor(datos.prueba$MINKGEM, levels = 0:9)
datos.prueba$MKOOPKLA <- factor(datos.prueba$MKOOPKLA, levels = 0:9)
datos.prueba$PWAPART <- factor(datos.prueba$PWAPART, levels = 0:9)
datos.prueba$PWABEDR <- factor(datos.prueba$PWABEDR, levels = 0:9)
datos.prueba$PWALAND <- factor(datos.prueba$PWALAND, levels = 0:9)
datos.prueba$PPERSAUT <- factor(datos.prueba$PPERSAUT, levels = 0:9)
datos.prueba$PBESAUT <- factor(datos.prueba$PBESAUT, levels = 0:9)
datos.prueba$PMOTSCO <- factor(datos.prueba$PMOTSCO, levels = 0:9)
datos.prueba$PVRAAUT <- factor(datos.prueba$PVRAAUT, levels = 0:9)
datos.prueba$PAANHANG <- factor(datos.prueba$PAANHANG, levels = 0:9)
datos.prueba$PTRACTOR <- factor(datos.prueba$PTRACTOR, levels = 0:9)
datos.prueba$PWERKT <- factor(datos.prueba$PWERKT, levels = 0:9)
datos.prueba$PBROM <- factor(datos.prueba$PBROM, levels = 0:9)
datos.prueba$PLEVEN <- factor(datos.prueba$PLEVEN, levels = 0:9)
datos.prueba$PPERSONG <- factor(datos.prueba$PPERSONG, levels = 0:9)
datos.prueba$PGEZONG <- factor(datos.prueba$PGEZONG, levels = 0:9)
datos.prueba$PWAOREG <- factor(datos.prueba$PWAOREG, levels = 0:9)
datos.prueba$PBRAND <- factor(datos.prueba$PBRAND, levels = 0:9)
datos.prueba$PZEILPL <- factor(datos.prueba$PZEILPL, levels = 0:9)
datos.prueba$PPLEZIER <- factor(datos.prueba$PPLEZIER, levels = 0:9)
datos.prueba$PFIETS <- factor(datos.prueba$PFIETS, levels = 0:9)
datos.prueba$PINBOED <- factor(datos.prueba$PINBOED, levels = 0:9)
datos.prueba$PBYSTAND <- factor(datos.prueba$PBYSTAND, levels = 0:9)

idx.to.remove = datos.prueba$PPERSAUT =="9"
# remover los factores que solo existen en los datos de prueba
datos.prueba<- datos.prueba[!(idx.to.remove),]
##Se cargan los resultados
datos.resultado = read.table('tictgts2000.txt', header = F, col.names = c("CARAVAN"))
datos.resultado$CARAVAN = factor(datos.resultado$CARAVAN)

datos.prueba$CARAVAN = datos.resultado[!idx.to.remove,]

regresion.prueba <- datos.prueba
```

### Regresión logística

Se procede a realizar las predicciones, a partir de los datos de prueba suministrados

```{r}
regresion.prueba$probabilidades <- predict(modelo.logistica, newdata = regresion.prueba)
regresion.prueba$proba_si <- predict(modelo.logistica, newdata = regresion.prueba, type = "response")
tabla.confusion = table(regresion.prueba$CARAVAN, regresion.prueba$proba_si >= 0.5)

sensibilidad = tabla.confusion[2,"TRUE"] / (sum(tabla.confusion[2]))
especificidad = tabla.confusion[1,"FALSE"] / (sum(tabla.confusion[1]))
exactitud = (tabla.confusion[1,"FALSE"] = tabla.confusion[1,"FALSE"]) / nrow(datos.prueba)

```

Se obtienen las siguientes medidas respecto a los datos:

* Sensibilidad (proporción de los positivos observados cuya predicción es positiva): `r sensibilidad`

* Especifidad (Proporción de los negativos observados cuya predicción es negativa): `r especificidad`

* Exactitud (cantidad de verdaderos positivos y negativos, entre todos los datos de prueba) :  `r exactitud`

Fnalmente, la curva ROC del modelo en cuestión: 
```{r}
regresion.roc <- prediction(regresion.prueba$proba_si, regresion.prueba$CARAVAN)
auc = as.numeric(performance(regresion.roc, "auc")@y.values)
ROCR.logistica  <- performance(regresion.roc, "tpr", "fpr")
plot(ROCR.logistica,
main = 'Curva ROC - regresion logística',
print.cutoffs.at = seq(0.1, by=0.1),
colorize=T,
text.adj = c(-0.2, 1.7))

```

Es claro ver en la curva ROC que el modelo no es tan eficiente, pues su curva está mas bien cercana a un ángulo de 45 grados. El área bajo la curva es de `r auc`